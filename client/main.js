var e=require("fs"),t=require("electron");var n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},r=t,o={};Object.defineProperty(o,"__esModule",{value:!0});var a=void 0;o.UpdatePreview=a;var i,d={};i=d,Object.defineProperty(i,"__esModule",{value:!0});var s;var u="undefined"==typeof document?void 0:document,c=!!u&&"content"in u.createElement("template"),l=!!u&&u.createRange&&"createContextualFragment"in u.createRange();function p(e){return e=e.trim(),c?function(e){var t=u.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):l?function(e){return s||(s=u.createRange()).selectNode(u.body),s.createContextualFragment(e).childNodes[0]}(e):function(e){var t=u.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function m(e,t){var n,r,o=e.nodeName,a=t.nodeName;return o===a||(n=o.charCodeAt(0),r=a.charCodeAt(0),n<=90&&r>=97?o===a.toUpperCase():r<=90&&n>=97&&a===o.toUpperCase())}function f(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var h={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}f(e,t,"selected")},INPUT:function(e,t){f(e,t,"checked"),f(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,a=0,i=e.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))i=(n=i).firstChild;else{if("OPTION"===r){if(i.hasAttribute("selected")){o=a;break}a++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}e.selectedIndex=o}}};function v(){}function y(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var g,w=(g=function(e,t){var n,r,o,a,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var d=i.length-1;d>=0;d--)r=(n=i[d]).name,o=n.namespaceURI,a=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==a&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,a))):e.getAttribute(r)!==a&&e.setAttribute(r,a);for(var s=e.attributes,u=s.length-1;u>=0;u--)r=(n=s[u]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}},function(e,t,n){if(n||(n={}),"string"==typeof t)if("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName){var r=t;(t=u.createElement("html")).innerHTML=r}else t=p(t);var o=n.getNodeKey||y,a=n.onBeforeNodeAdded||v,i=n.onNodeAdded||v,d=n.onBeforeElUpdated||v,s=n.onElUpdated||v,c=n.onBeforeNodeDiscarded||v,l=n.onNodeDiscarded||v,f=n.onBeforeElChildrenUpdated||v,w=!0===n.childrenOnly,b=Object.create(null),x=[];function M(e){x.push(e)}function C(e,t,n){!1!==c(e)&&(t&&t.removeChild(e),l(e),function e(t,n){if(1===t.nodeType)for(var r=t.firstChild;r;){var a=void 0;n&&(a=o(r))?M(a):(l(r),r.firstChild&&e(r,n)),r=r.nextSibling}}(e,n))}function N(e){i(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=o(t);if(r){var a=b[r];a&&m(t,a)?(t.parentNode.replaceChild(a,t),S(a,t)):N(t)}else N(t);t=n}}function S(e,t,n){var r=o(t);if(r&&delete b[r],!n){if(!1===d(e,t))return;if(g(e,t),s(e),!1===f(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var n,r,i,d,s,c=t.firstChild,l=e.firstChild;e:for(;c;){for(d=c.nextSibling,n=o(c);l;){if(i=l.nextSibling,c.isSameNode&&c.isSameNode(l)){c=d,l=i;continue e}r=o(l);var p=l.nodeType,f=void 0;if(p===c.nodeType&&(1===p?(n?n!==r&&((s=b[n])?i===s?f=!1:(e.insertBefore(s,l),r?M(r):C(l,e,!0),l=s):f=!1):r&&(f=!1),(f=!1!==f&&m(l,c))&&S(l,c)):3!==p&&8!=p||(f=!0,l.nodeValue!==c.nodeValue&&(l.nodeValue=c.nodeValue))),f){c=d,l=i;continue e}r?M(r):C(l,e,!0),l=i}if(n&&(s=b[n])&&m(s,c))e.appendChild(s),S(s,c);else{var v=a(c);!1!==v&&(v&&(c=v),c.actualize&&(c=c.actualize(e.ownerDocument||u)),e.appendChild(c),N(c))}c=d,l=i}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=o(t))?M(n):C(t,e,!0),t=r}}(e,l,r);var y=h[e.nodeName];y&&y(e,t)}(e,t):h.TEXTAREA(e,t)}!function e(t){if(1===t.nodeType||11===t.nodeType)for(var n=t.firstChild;n;){var r=o(n);r&&(b[r]=n),e(n),n=n.nextSibling}}(e);var T,E,R=e,A=R.nodeType,L=t.nodeType;if(!w)if(1===A)1===L?m(e,t)||(l(e),R=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(e,(T=t.nodeName,(E=t.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==E?u.createElementNS(E,T):u.createElement(T)))):R=t;else if(3===A||8===A){if(L===A)return R.nodeValue!==t.nodeValue&&(R.nodeValue=t.nodeValue),R;R=t}if(R===t)l(e);else{if(t.isSameNode&&t.isSameNode(R))return;if(S(R,t,w),x)for(var q=0,P=x.length;q<P;q++){var J=b[x[q]];J&&C(J,J.parentNode,!1)}}return!w&&R!==e&&e.parentNode&&(R.actualize&&(R=R.actualize(e.ownerDocument||u)),e.parentNode.replaceChild(R,e)),R});d.default=w;var b,x=(b=d)&&b.__esModule?b:{default:b};a=class{constructor(e,t){this.dom=e,this.mjController=t}async update(e,t){for(const t of Array.from(e.querySelectorAll("span.math"))){const e=t.firstElementChild;e&&"SCRIPT"===e.nodeName&&(t.isSameNode=function(t){if("SPAN"!==t.nodeName)return!1;const n=t;if(!n.classList.contains("math"))return!1;const r=n.querySelector("script");return!!r&&(e.innerHTML===r.innerHTML&&e.type===r.type)})}if((0,x.default)(this.dom,e,{childrenOnly:!0,onBeforeElUpdated:function(e,t){return!e.isEqualNode(t)},getNodeKey:function(e){return e.id&&e.closest&&null!==e.closest("svg")?"":e.id}}),t)return this.mjController.queueTypeset(this.dom)}},o.UpdatePreview=a;var M={};Object.defineProperty(M,"__esModule",{value:!0});var C=function(e){const t=document.getElementById("MathJax_SVG_Hidden"),n=t&&t.parentElement;return null!==n?n.outerHTML+e.innerHTML:e.innerHTML};M.processHTMLString=C;var N=void 0;M.MathJaxController=N;class S{constructor(e,t){this.userMacros=e,this.mathJaxConfig=t,this.readyPromise=this.attachMathJax()}static async create(e,t){const n=new S(e,t);return await n.readyPromise,n}dispose(){const e=document.head.querySelector(`script[src='${S.mjSrc}']`);e&&e.remove()}jaxTeXConfig(){return{extensions:this.mathJaxConfig.texExtensions,Macros:this.userMacros,equationNumbers:this.mathJaxConfig.numberEquations?{autoNumber:"AMS",useLabelIds:!1}:{}}}async queueTypeset(e){if(Array.from(document.querySelectorAll('script[type^="math/tex"]')).some(e=>!e.id))return new Promise(t=>{MathJax.InputJax.TeX&&(MathJax.Hub.Queue(["resetEquationNumbers",MathJax.InputJax.TeX]),this.mathJaxConfig.numberEquations&&(MathJax.Hub.Queue(["PreProcess",MathJax.Hub]),MathJax.Hub.Queue(["Reprocess",MathJax.Hub]))),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e]),MathJax.Hub.Queue([t])})}async attachMathJax(){await async function(e){const t=document.createElement("script");return t.src=e,t.type="text/javascript",document.head.appendChild(t),new Promise(e=>{t.addEventListener("load",()=>e())})}(S.mjSrc),MathJax.Hub.Config({jax:["input/TeX","output/"+this.mathJaxConfig.latexRenderer],extensions:[],TeX:this.jaxTeXConfig(),"HTML-CSS":{availableFonts:[],webFont:"TeX",imageFont:null,undefinedFamily:this.mathJaxConfig.undefinedFamily,mtextFontInherit:!0},messageStyle:"none",showMathMenu:!1,skipStartupTypeset:!0}),MathJax.Hub.Configured()}}N=S,M.MathJaxController=N,S.mjSrc=n.require.resolve("mathjax")+"?delayStartupUntil=configured";var T={};Object.defineProperty(T,"__esModule",{value:!0});var E=function(e){if(!e)return;e.catch(e=>{console.error(e)})};T.handlePromise=E;var R=function(e){return!!(0,L.existsSync)(e)&&(0,L.lstatSync)(e).isFile()};T.isFileSync=R;var A=function(e,t){let n=e;for(const e of t){const t=n.querySelectorAll(":scope > "+e.tag).item(e.index);if(!t)break;n=t}return n===e?void 0:n};T.resolveElement=A;var L=e;var q=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=k();if(t&&t.has(e))return t.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var a=r?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(n,o,a):n[o]=e[o]}n.default=e,t&&t.set(e,n);return n}(T),P={};Object.defineProperty(P,"__esModule",{value:!0});var J=function(e){return e.querySelectorAll("img[src],audio[src],video[src],link[href]")};function k(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return k=function(){return e},e}let H;P.getMedia=J,window.addEventListener("error",e=>{const t=e.error;r.ipcRenderer.send("atom-markdown-preview-plus-ipc-uncaught-error",H,{message:t.message,name:t.name,stack:t.stack})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason;r.ipcRenderer.send("atom-markdown-preview-plus-ipc-uncaught-error",H,{message:t.message,name:t.name,stack:t.stack})});const O={mathJax:function(){let e;const t=new Promise(t=>e=t);return t.resolve=e,t}(),sourceLineMap:new Map,revSourceMap:new WeakMap};let j;r.ipcRenderer.on("set-id",(e,t)=>{H=t}),r.ipcRenderer.on("init",(e,t)=>{O.mathJax.resolve(M.MathJaxController.create(t.userMacros,t.mathJaxConfig)),document.documentElement.dataset.markdownPreviewPlusContext=t.context,"pdf-export"===t.context&&document.documentElement.style.setProperty("width",t.pdfExportOptions.width+"mm","important")}),r.ipcRenderer.on("set-source-map",(e,{map:t})=>{const n=document.querySelector("div.update-preview");if(!n)throw new Error("No root element!");const r=new Map,o=new WeakMap;for(const[e,a]of Object.entries(t)){const t=parseInt(e,10),i=q.resolveElement(n,a);if(i){r.set(t,i);const e=o.get(i);e?e.push(t):o.set(i,[t])}}O.sourceLineMap=r,O.revSourceMap=o}),r.ipcRenderer.on("scroll-sync",(e,{firstLine:t,lastLine:n})=>{const r=Math.floor(.5*(t+n)),o=O.sourceLineMap;let a,i;for(a=r;a>=0&&(i=o.get(a),!i);a-=1);if(!i)return;const d=Math.max(...Array.from(o.keys()));let s,u;for(s=r+1;s<d&&(u=o.get(s),!u);s+=1);if(!u)return;const c=i.getBoundingClientRect().top,l=u.getBoundingClientRect().top,p=(r-t)/(n-t),m=document.documentElement.scrollTop-document.documentElement.clientHeight/2+c+p*(l-c);window.scroll({top:m})}),r.ipcRenderer.on("style",(e,{styles:t})=>{let n=document.head.querySelector("style#atom-styles");n||(n=document.createElement("style"),n.id="atom-styles",document.head.appendChild(n)),n.innerHTML=t.join("\n")}),r.ipcRenderer.on("update-images",(e,{oldsrc:t,v:n})=>{const r=(0,P.getMedia)(document);for(const e of Array.from(r)){let r,o,a;a="LINK"===e.tagName?"href":"src";let i=e.getAttribute(a);const d=i.match(/^(.*)\?v=(\d+)$/);d&&([,i,r]=d),i===t&&(void 0!==r&&(o=parseInt(r,10)),n!==o&&(e[a]=n?`${i}?v=${n}`:""+i))}}),r.ipcRenderer.on("sync",(e,{line:t,flash:n})=>{if(!document.querySelector("div.update-preview"))return;let r=O.sourceLineMap.get(t);if(!r)for(let e=t-1;e>=0&&(r=O.sourceLineMap.get(t),!r);e-=1);r&&(r.scrollIntoViewIfNeeded(!0),n&&(r.classList.add("flash"),setTimeout(()=>r.classList.remove("flash"),1e3)))}),r.ipcRenderer.on("update-preview",async(e,{id:t,html:n,renderLaTeX:a})=>{const i=document.querySelector("div.update-preview");if(!i)return;j||(j=new o.UpdatePreview(i,await O.mathJax));const d=(new DOMParser).parseFromString(n,"text/html"),s=document;if(s&&d.head.hasChildNodes){let e=s.head.querySelector("original-elements");e||(e=s.createElement("original-elements"),s.head.appendChild(e)),e.innerHTML="";for(const t of Array.from(d.head.childNodes))e.appendChild(t)}await j.update(d.body,a),r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"update-preview",result:(0,M.processHTMLString)(i)})}),r.ipcRenderer.on("await-fully-ready",async(e,{id:t})=>{"complete"!==document.readyState?document.addEventListener("load",(function e(){r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"await-fully-ready",result:void 0}),document.removeEventListener("load",e)})):r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"await-fully-ready",result:void 0})});const I=document.createElement("base");let U;document.head.appendChild(I),r.ipcRenderer.on("set-base-path",(e,{path:t})=>{I.href=t||""}),r.ipcRenderer.on("error",(e,{msg:t})=>{const n=document.querySelector("div.update-preview");if(!n)return;const r=document.createElement("div");r.innerHTML=`<h2>Previewing Markdown Failed</h2><h3>${t}</h3>`,n.appendChild(r)}),document.addEventListener("wheel",e=>{e.ctrlKey&&(e.deltaY>0?r.ipcRenderer.send("atom-markdown-preview-plus-ipc-zoom-in",H):e.deltaY<0&&r.ipcRenderer.send("atom-markdown-preview-plus-ipc-zoom-out",H),e.preventDefault(),e.stopPropagation())}),document.addEventListener("scroll",e=>{const t=document.documentElement.clientHeight,n=Array.from(O.sourceLineMap.entries()).filter(([e,n])=>{const{top:r,bottom:o}=n.getBoundingClientRect();return r>0&&o<t}).map(([e,t])=>e);r.ipcRenderer.send("atom-markdown-preview-plus-ipc-did-scroll-preview",H,{max:Math.max(...n),min:Math.min(...n)})}),document.addEventListener("contextmenu",e=>{U=e.target,r.ipcRenderer.send("atom-markdown-preview-plus-ipc-show-context-menu",H)}),r.ipcRenderer.on("sync-source",(e,{id:t})=>{let n=U;const o=O.revSourceMap;let a=o.get(n);for(;!a&&n.parentElement;)n=n.parentElement,a=o.get(n);a&&r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"sync-source",result:Math.min(...a)})}),r.ipcRenderer.on("reload",(e,{id:t})=>{window.onbeforeunload=null,r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"reload",result:void 0})}),window.onbeforeunload=function(){return!1},r.ipcRenderer.on("get-tex-config",async(e,{id:t})=>{r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"get-tex-config",result:(await O.mathJax).jaxTeXConfig()})}),r.ipcRenderer.on("get-selection",async(e,{id:t})=>{const n=window.getSelection(),o=n&&n.toString(),a=n&&n.anchorNode;r.ipcRenderer.send("atom-markdown-preview-plus-ipc-request-reply",H,{id:t,request:"get-selection",result:o&&a?o:void 0})}),document.addEventListener("click",e=>{if(!e.target)return;const t=e.target;if("A"===t.tagName){const n=t.getAttribute("href");if(n&&n.startsWith("#")){e.preventDefault();const t=document.getElementById(decodeURIComponent(n).slice(1));t&&t.scrollIntoView()}}});
//# sourceMappingURL=main.js.map
